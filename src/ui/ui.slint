import { 
    LineEdit, Button, ComboBox, GridBox , CheckBox, TextEdit, 
    ScrollView, StandardListView , HorizontalBox, SpinBox
} from "std-widgets.slint";

export component AnyServeUI inherits Window {
    callback startstop_ftp_server(bool);
    callback startstop_tftp_server(bool);
    callback startstop_http_server(bool);
    callback startstop_dhcp_server(bool);
    callback show-open-dialog;

    in-out property <string> le_path <=> lePath.text;
    in-out property <string> le_bind_address <=> leBindAddress.text;

    out property <int> sb_ftp_port <=> sbFTPPort.value;
    out property <int> sb_tftp_port <=> sbTFTPPort.value;
    out property <int> sb_http_port <=> sbHTTPPort.value;
    // out property <int> sb_dhcp_port <=> sbHTTPPort.value;

    out property <bool> cb_auto_scroll <=> cbAutoScroll.checked;

    in property <bool> bt_start_ftp <=> btStartFTP.checked;
    in property <bool> bt_start_tftp <=> btStartTFTP.checked;
    in property <bool> bt_start_http <=> btStartHTTP.checked;
    in property <bool> bt_start_dhcp <=> btStartDHCP.checked;

    private property <length> labels-width: 45px;
    private property <length> buttons-width: 120px;

    public function add_log_line (line: string) {
        teLogs.text += line + "\n";
    }

    private property <length> pos;
    private property <length> new_pos;

    // public function is_glued() -> bool {
    //     // TODO: not working well
    //     pos = (teLogs.viewport-height + 38.0px - teLogs.height) * -1.0;
    //     if (teLogs.viewport_y == pos) {
    //         return true;
    //     }
    //     return false;
    // }

    public function textedit_scroll_to_end () {
        // TODO: make sure this "frame-margin" = 38 is true for all the OSs. Maybe calculate it in the begining
        new_pos = (teLogs.viewport-height + 38.0px - teLogs.height) * -1.0;
        teLogs.viewport_y = new_pos;
    }

    title: "Any-serve";
    icon: @image-url("serve.png");

    preferred-height: 810px;
    min-height: 800px;

    preferred-width: 610px;
    min-width: 300px;

    GridBox {
        GridBox {
            row: 0;
            Text {
                col: 0;
                width: labels-width;
                text: "Path";
                font-weight: 600; // From 100 to 900, 400 by default
                horizontal-alignment: right;
                vertical-alignment: center;
            }
            lePath := LineEdit {
                col: 1;
                text: "/tmp/";
            }
            btPath := Button {
                col: 2;
                text: "ðŸ“‚";
                clicked => { root.show-open-dialog(); }
            }
        }
        GridBox {
            row: 1;
            Text {
                col: 0;
                width: labels-width;
                font-weight: 600;
                text: "Bind\naddress";
                horizontal-alignment: right;
                vertical-alignment: center;
            }
            leBindAddress := LineEdit {
                col: 1;
                text: "127.0.0.1";
            }
        }
        GridBox {
            row: 2;

            GridBox {
                col: 0;
                btStartTFTP := Button {
                    row: 0;
                    width: buttons-width;
                    text: "TFTP";
                    checkable: true;

                    clicked => {
                        root.startstop_tftp_server(btStartTFTP.checked);
                    }
                }
                sbTFTPPort := SpinBox {
                    row: 1;
                    // vertical-stretch: 0;
                    width: buttons-width;
                    maximum: 65000;
                    minimum: 20;
                    value: 6969;
                    // enabled: GallerySettings.widgets-enabled;
                }
            }
            // 
            // 
            GridBox {
                col: 1;
                btStartFTP := Button {
                    row: 0;
                    width: buttons-width;
                    text: "FTP";
                    checkable: true;

                    clicked => {
                        root.startstop_ftp_server(btStartFTP.checked);
                    }
                }
                sbFTPPort := SpinBox {
                    row: 1;
                    // vertical-stretch: 0;
                    width: buttons-width;
                    maximum: 65000;
                    minimum: 20;
                    value: 2121;
                    // enabled: GallerySettings.widgets-enabled;
                }
            }
            // 
            //
            GridBox {
                col: 2;
                btStartHTTP := Button {
                    row: 0;
                    width: buttons-width;
                    text: "HTTP";
                    checkable: true;

                    clicked => {
                        root.startstop_http_server(btStartHTTP.checked);
                    }
                }
                sbHTTPPort := SpinBox {
                    row: 1;
                    // vertical-stretch: 0;
                    width: buttons-width;
                    maximum: 65000;
                    minimum: 20;
                    value: 8080;
                    // enabled: GallerySettings.widgets-enabled;
                }
            }

            GridBox {
                col: 3;
                btStartDHCP := Button {
                    width: buttons-width;
                    text: "DHCP";
                    checkable: true;

                    clicked => {
                        root.startstop_dhcp_server(btStartDHCP.checked);
                    }
                }
            }

            Rectangle {}
        }

        teLogs := TextEdit {
            row: 3;
            read-only: true;
            wrap: no-wrap;
        }

        cbAutoScroll := CheckBox {
            row: 4;
            checked: true;
            text: "Auto scroll";
        }
    }
}
